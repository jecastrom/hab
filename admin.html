<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Admin ‚Äì Melder Suche</title>
    <script src="auth-guard.js"></script>
    <script src="webauthn-json.js"></script>
    <style>
        :root {
            --bg-color: #f8f9fa; --text-color: #212529; --card-bg: #ffffff; --border-color: #dee2e6;
            --primary-color: #0d6efd; --success: #198754; --danger: #dc3545; --help: #6c757d;
            --overlay-bg: rgba(0, 0, 0, 0.4);
        }
        body.dark-mode {
            --bg-color: #121212; --text-color: #e9ecef; --card-bg: #1e1e1e; --border-color: #495057; --secondary-text: #adb5bd;
            --overlay-bg: rgba(0, 0, 0, 0.7);
        }
        body {
            font-family: -apple-system, system-ui, sans-serif; background-color: var(--bg-color);
            color: var(--text-color); margin: 0; padding: 0; display: flex; min-height: 100vh;
            transition: background-color 0.3s; overflow-x: hidden;
        }
        
        /* Mobile Layout Default */
        .container { width: 100%; max-width: 1000px; margin: 0 auto; padding: 20px; padding-top: 70px; box-sizing: border-box; }

        .sidebar {
            width: 280px; background: var(--card-bg); padding: 20px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1); transition: transform 0.3s ease;
            border-right: 1px solid var(--border-color); z-index: 1500;
            display: flex; flex-direction: column; position: fixed; left: 0; top: 0; height: 100%;
            transform: translateX(-100%);
        }
        .sidebar.open { transform: translateX(0); }
        #sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--overlay-bg); z-index: 1400; display: none; opacity: 0; transition: opacity 0.3s; }
        #sidebar-overlay.visible { display: block; opacity: 1; }

        .sidebar-header { padding-top: 40px; margin-bottom: 30px; }
        .sidebar-header h1 { font-size: 1.4em; margin: 0; color: var(--primary-color); }
        .sidebar ul { list-style: none; padding: 0; flex-grow: 1; }
        .sidebar li { margin-bottom: 25px; }
        .sidebar a { display: flex; align-items: center; gap: 12px; text-decoration: none; color: var(--text-color); font-weight: bold; cursor: pointer; }
        .sidebar a.active { color: var(--primary-color); }
        .menu-icon { width: 28px; text-align: center; display: inline-block; font-size: 1.2rem; }

        .sidebar-footer { padding: 20px 0 30px; border-top: 1px solid var(--border-color); margin-top: auto; }
        .setting-item { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; font-size: 0.9rem; font-weight: 600; }
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary-color); }
        input:checked + .slider:before { transform: translateX(20px); }
        .btn-logout { width: 100%; background: var(--danger); color: white; border: none; padding: 14px; border-radius: 10px; cursor: pointer; font-weight: bold; font-size: 1rem; }

        .main-card { display: none; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 16px; padding: 25px; margin-bottom: 30px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); box-sizing: border-box; }
        .main-card.active { display: block; }
        
        h2 { margin-top: 0; color: var(--primary-color); font-size: 1.2rem; }
        label { display: block; margin: 15px 0 8px; font-weight: 600; font-size: 0.85rem; }
        input, select { width: 100%; padding: 14px; box-sizing: border-box; background: var(--bg-color); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 10px; font-size: 1rem; }
        
        .action-btn { width: 100%; padding: 16px; margin-top: 20px; border: none; border-radius: 12px; font-size: 1em; font-weight: bold; cursor: pointer; }
        .btn-add { background: var(--success); color: white; }
        .btn-upload { background: var(--primary-color); color: white; }
        .btn-delete { background: var(--danger); color: white; }

        .objekt-card { background: var(--bg-color); padding: 18px; border-radius: 12px; border: 1px solid var(--border-color); display: flex; align-items: center; gap: 15px; cursor: pointer; margin-bottom: 10px; }
        .objekt-card input { width: 22px; height: 22px; margin: 0; }

        .hamburger { position: fixed; top: 18px; left: 18px; z-index: 1300; cursor: pointer; width: 30px; }
        .hamburger span { display: block; width: 100%; height: 3px; background: var(--text-color); margin-bottom: 6px; border-radius: 4px; }
        .sidebar-close { position: absolute; top: 15px; right: 15px; font-size: 2rem; color: var(--danger); cursor: pointer; }

        #message { position: fixed; top: 0; left: 0; width: 100%; padding: 15px; text-align: center; display: none; z-index: 2000; font-weight: bold; }
        .success { background: #d1e7dd; color: #0f5132; }
        .error { background: #f8d7da; color: #842029; }

        /* DESKTOP ADJUSTMENTS */
        @media (min-width: 1024px) {
            .sidebar { transform: translateX(0); box-shadow: none; border-right: 1px solid var(--border-color); }
            .hamburger, .sidebar-close, #sidebar-overlay { display: none !important; }
            
            .container {
                margin-left: 280px; 
                width: calc(100% - 280px);
                max-width: none;
                display: flex;
                flex-direction: column;
                align-items: center;
                padding-top: 50px;
            }

            .main-content {
                width: 100%;
                display: flex;
                flex-direction: column;
                align-items: center;
            }

            .main-card {
                width: 600px;           /* Proportionate rectangular width */
                display: none;
                margin: 0 auto;
                position: relative;
                min-height: auto;      /* Eliminates forced empty space */
            }
            .main-card.active { display: block; }

            #objektList {
                max-height: 250px;
                overflow-y: auto;
                margin-bottom: 10px;
                padding-right: 5px;
            }
        }
    </style>
</head>
<body>
    <div id="message"></div>
    <div id="sidebar-overlay" onclick="toggleSidebar()"></div>
    <div class="hamburger" onclick="toggleSidebar()"><span></span><span></span><span></span></div>

    <div class="container">
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-close" onclick="toggleSidebar()">&times;</div>
            <div class="sidebar-header"><h1>Admin Panel</h1></div>
            <ul>
                <li><a onclick="showSection('create')" class="active"><span class="menu-icon">‚ûï</span> Neues Objekt</a></li>
                <li><a onclick="showSection('upload')"><span class="menu-icon">üì§</span> Daten Upload</a></li>
                <li><a onclick="showSection('delete')"><span class="menu-icon">üóëÔ∏è</span> L√∂schen</a></li>
                <li><a onclick="showSection('user_admin')"><span class="menu-icon">üë•</span> Benutzer</a></li>
                <li><a href="index.html"><span class="menu-icon">üîç</span> Suche</a></li>
            </ul>

            <div class="sidebar-footer">
                <div class="setting-item">
                    <span>üåô Dunkelmodus</span>
                    <label class="switch"><input type="checkbox" id="dark-toggle" onchange="toggleTheme()"><span class="slider"></span></label>
                </div>
                <div class="setting-item">
                    <span>üîí Biometrie</span>
                    <label class="switch"><input type="checkbox" id="bio-toggle" onchange="handleBioToggle(this)"><span class="slider"></span></label>
                </div>
                <span id="bio-status" style="font-size:0.7rem; color:var(--help); text-align:center; display:block; margin-bottom:15px; font-style:italic;">Pr√ºfe Modul...</span>
                <button class="btn-logout" onclick="logout()">Abmelden</button>
            </div>
        </nav>

        <main class="main-content">
            <h1 style="text-align:center; color:var(--primary-color); margin-bottom:30px;">Administration</h1>

            <section id="create" class="main-card active">
                <h2>Neues Objekt hinzuf√ºgen</h2>
                <label>Objekt-Code (Alphanumerisch):</label>
                <input type="text" id="obj_fld" placeholder="Z.B. ABC123" autocomplete="off" style="text-transform: uppercase;"
                oninput="this.value = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '')">
                <button class="action-btn btn-add" onclick="addObject()">Speichern</button>
            </section>

            <section id="upload" class="main-card">
                <h2>Datendatei hochladen</h2>
                <label>Objekt w√§hlen:</label>
                <select id="linkedObjekte"></select>
                <label>Datenquelle:</label>
                <select id="sourceType">
                    <option value="esser">ESSER Tools 8000 (CSV)</option>
                     <option value="" disabled>Hekatron IAC Datai (Inaktiv, bitte Administrator kontaktieren)</option>
                </select>
                <label>Datei ausw√§hlen:</label>
                <input type="file" id="uploadFile" accept=".csv">
                <button class="action-btn btn-upload" id="uploadBtn" onclick="uploadFileProcess()">Datei verarbeiten</button>
            </section>

            <section id="delete" class="main-card">
                <h2>Objekt l√∂schen</h2>
                <div id="objektList"></div>
                <button class="action-btn btn-delete" onclick="deleteObject()" id="deleteBtn" disabled>Markiertes entfernen</button>
            </section>

            <section id="user_admin" class="main-card">
                <h2>Benutzerverwaltung</h2>
                <label>Benutzername</label>
                <input type="text" id="new_user_name" placeholder="Name" autocomplete="off">
                <label>Passwort</label>
                <input type="password" id="new_user_pw" placeholder="Passwort">
                <label>Rolle</label>
                <select id="new_user_role">
                    <option value="standard">Teammitglied</option>
                    <option value="admin">Techniker Administrator</option>
                </select>
                <button class="action-btn btn-add" onclick="createNewUser()">Benutzer anlegen</button>
            </section>
        </main>
    </div>

    <script>
        const API_BASE = 'https://hab-api-functions-agf8hya9f2cgdeaf.westus2-01.azurewebsites.net/api';

        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebar-overlay');
        function toggleSidebar() { 
            const isOpen = sidebar.classList.toggle('open');
            overlay.classList.toggle('visible', isOpen);
        }

        window.addEventListener('storage', (e) => {
            if (e.key === 'darkMode') {
                const isDark = e.newValue === 'enabled';
                document.body.classList.toggle('dark-mode', isDark);
                document.getElementById('dark-toggle').checked = isDark;
            }
            if (e.key === 'bio_registered_user') {
                document.getElementById('bio-toggle').checked = !!e.newValue;
            }
        });

        function showSection(id) {
            document.querySelectorAll('.main-card').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.sidebar a').forEach(a => a.classList.remove('active'));
            const activeLink = document.querySelector(`.sidebar a[onclick*="${id}"]`);
            if(activeLink) activeLink.classList.add('active');
            if(window.innerWidth < 1024) toggleSidebar();
            if(id === 'upload' || id === 'delete') loadObjekte();
        }

        async function handleBioToggle(checkbox) {
            const username = localStorage.getItem('username');
            if (!window.webauthnJson) return;
            if (checkbox.checked) {
                try {
                    const challenge = btoa("1234567890123456").replace(/\+/g, '-').replace(/_/g, '/');
                    const userId = btoa(username || 'user').replace(/\+/g, '-').replace(/_/g, '/');
                    const credential = await window.webauthnJson.create({
                        publicKey: { challenge, rp: { name: "Melder Suche", id: window.location.hostname }, user: { id: userId, name: username || 'user', displayName: username || 'user' }, pubKeyCredParams: [{ type: "public-key", alg: -7 }], authenticatorSelection: { userVerification: "required" }, timeout: 60000 }
                    });
                    const res = await fetch(`${API_BASE}/register-biometric`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${localStorage.getItem('token')}` }, body: JSON.stringify({ credential }) });
                    if (res.ok) { localStorage.setItem('bio_registered_user', username); showMessage("Biometrie aktiviert!", true); }
                } catch (err) { checkbox.checked = !!localStorage.getItem('bio_registered_user'); }
            } else {
                if(!confirm("Biometrie deaktivieren?")) { checkbox.checked = true; return; }
                try {
                    const res = await fetch(`${API_BASE}/register-biometric`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${localStorage.getItem('token')}` }, body: JSON.stringify({ action: 'delete' }) });
                    if (res.ok) { localStorage.removeItem('bio_registered_user'); showMessage("Biometrie entfernt.", true); }
                } catch (e) { checkbox.checked = true; }
            }
        }

        function toggleTheme() {
            const isDark = document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', isDark ? 'enabled' : 'disabled');
        }

        function logout() { localStorage.removeItem('token'); localStorage.removeItem('role'); window.location.href = 'login.html'; }

        async function addObject() {
            const field = document.getElementById('obj_fld');
            const code = field.value.trim().toUpperCase();
            if(!code) return;
            const res = await fetch(`${API_BASE}/add-object`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ code }) });
            if(res.ok) { showMessage('Objekt gespeichert', true); field.value = ''; }
        }

        async function createNewUser() {
            const n = document.getElementById('new_user_name').value.trim();
            const p = document.getElementById('new_user_pw').value.trim();
            const r = document.getElementById('new_user_role').value;
            if(!n || !p) return showMessage("Daten fehlen", false);
            const res = await fetch(`${API_BASE}/add-user`, { method: 'POST', headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${localStorage.getItem('token')}`}, body: JSON.stringify({ newUsername: n, newPassword: p, newRole: r }) });
            if(res.ok) { showMessage("Benutzer erstellt", true); document.getElementById('new_user_name').value=''; document.getElementById('new_user_pw').value=''; }
        }

        async function loadObjekte() {
            try {
                const res = await fetch(`${API_BASE}/get-objects`);
                const objects = await res.json();
                const list = document.getElementById('objektList');
                const select = document.getElementById('linkedObjekte');
                list.innerHTML = ''; select.innerHTML = '';
                objects.forEach(obj => {
                    const opt = document.createElement('option'); opt.value = obj.id; opt.textContent = obj.display;
                    select.appendChild(opt);
                    const card = document.createElement('div'); card.className = 'objekt-card';
                    card.onclick = () => { const c = card.querySelector('input'); c.checked = !c.checked; toggleDelBtn(c); };
                    card.innerHTML = `<input type="checkbox" name="del" value="${obj.id}" onclick="event.stopPropagation(); toggleDelBtn(this)"> <strong>${obj.display}</strong>`;
                    list.appendChild(card);
                });
            } catch (e) {}
        }

        function toggleDelBtn(cb) {
            document.querySelectorAll('input[name="del"]').forEach(c => { if(c !== cb) c.checked = false; });
            document.getElementById('deleteBtn').disabled = !cb.checked;
        }

        async function uploadFileProcess() {
            const id = document.getElementById('linkedObjekte').value;
            const fileInput = document.getElementById('uploadFile');
            if(!id || !fileInput.files[0]) return showMessage("Daten fehlen", false);
            const btn = document.getElementById('uploadBtn'); btn.disabled = true;
            const reader = new FileReader();
            reader.onload = async (e) => {
                const data = csvToJSON(e.target.result);
                const res = await fetch(`${API_BASE}/upload-data`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ id, data, override: false }) });
                if(res.status === 409 && confirm("Datei existiert bereits. √úberschreiben?")) {
                    await fetch(`${API_BASE}/upload-data`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ id, data, override: true }) });
                }
                showMessage('Erfolgreich!', true); btn.disabled = false;
                document.getElementById('uploadFile').value = '';
            };
            reader.readAsText(fileInput.files[0], 'ISO-8859-1');
        }

        function csvToJSON(t) {
            const l = t.split(/\r?\n/); if(l.length < 4) return [];
            const d = l[2].includes(';') ? ';' : ',';
            const h = l[2].split(d).map(v => v.replace(/["\r]/g, '').replace(/\./g, '').trim());
            return l.slice(3).filter(x => x.trim()).map(x => {
                const v = x.split(d); const o = {};
                h.forEach((k, i) => {
                    let val = v[i] ? v[i].replace(/["\r¬¥¬∞%()]/g, '').replace(/[@\/.]/g, ' ').replace(/\s+/g, ' ').trim() : "";
                    if(k === "Nr") o["Gruppe"] = val; else if(k === "Zusatztext") o["Installationsort"] = val; else if(k === "Installationsort") o["Ring"] = val; else o[k] = val;
                });
                return o;
            });
        }

        async function deleteObject() {
            const el = document.querySelector('input[name="del"]:checked');
            const res = await fetch(`${API_BASE}/delete-object`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ id: el.value }) });
            if(res.ok) { showMessage("Gel√∂scht", true); loadObjekte(); }
        }

        function showMessage(t, s) {
            const m = document.getElementById('message'); m.textContent = t; m.className = s ? 'success' : 'error';
            m.style.display = 'block'; setTimeout(() => m.style.display = 'none', 3000);
        }

        window.onload = () => {
            if (localStorage.getItem('darkMode') === 'enabled') { document.body.classList.add('dark-mode'); document.getElementById('dark-toggle').checked = true; }
            if (window.webauthnJson) {
                document.getElementById('bio-status').textContent = "Biometrie bereit"; document.getElementById('bio-status').style.color = "var(--success)";
                if (localStorage.getItem('bio_registered_user')) document.getElementById('bio-toggle').checked = true;
            }
            loadObjekte();
        };
    </script>
</body>
</html>