<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Admin – Objekte verwalten</title>
    <style>
        :root {
            --bg: #f8f9fa;
            --text: #212529;
            --card-bg: #ffffff;
            --border: #dee2e6;
            --primary: #0d6efd;
            --success: #198754;
            --danger: #dc3545;
            --help: #6c757d;
        }
        body.dark-mode {
            --bg: #121212;
            --text: #e9ecef;
            --card-bg: #1e1e1e;
            --border: #495057;
            --help: #adb5bd;
        }
        body {
            font-family: Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            transition: background-color 0.3s, color 0.3s;
        }
        .container { display: flex; min-height: 100vh; }
        .sidebar {
            width: 250px;
            background: var(--card-bg);
            padding: 20px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            transition: transform 0.3s;
            border-right: 1px solid var(--border);
        }
        .sidebar-header h1 { font-size: 1.8em; margin: 0; }
        .sidebar-header h2 { font-size: 1.2em; margin: 10px 0 30px; color: var(--help); }
        .sidebar ul { list-style: none; padding: 0; }
        .sidebar li { margin-bottom: 40px; border-left: 4px solid transparent; padding-left: 10px; }
        .sidebar li:nth-child(1) { border-left-color: #dc3545; }
        .sidebar li:nth-child(3) { border-left-color: #0d6efd; }
        .sidebar a { display: block; text-decoration: none; color: var(--text); transition: color 0.2s; }
        .sidebar a:hover, .sidebar a.active { color: var(--primary); }
        .main { flex: 1; padding: 20px; max-width: 800px; margin: 0 auto; }
        .section { display: none; background: var(--card-bg); border: 1px solid var(--border); border-radius: 10px; padding: 20px; margin-bottom: 30px; }
        .section.active { display: block; }
        h1, h2 { color: var(--primary); text-align: center; }
        label { display: block; margin: 15px 0 5px; font-weight: bold; }
        input[type="text"], input[type="file"], select { width: 100%; padding: 10px; box-sizing: border-box; background: var(--card-bg); color: var(--text); border: 1px solid var(--border); border-radius: 5px; }
        
        button { 
            width: 100%; 
            padding: 12px; 
            margin-top: 15px; 
            border: none; 
            border-radius: 5px; 
            font-size: 1.1em; 
            cursor: pointer; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            gap: 10px;
            transition: opacity 0.2s;
        }
        button:disabled { opacity: 0.6; cursor: not-allowed; }
        
        .btn-add { background: var(--success); color: white; }
        .btn-upload { background: var(--primary); color: white; }
        .btn-delete { background: var(--danger); color: white; }

        .spinner {
            width: 18px;
            height: 18px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            display: none;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .help { font-size: 0.9em; color: var(--help); margin-top: 10px; }
        #message { position: fixed; top: 0; left: 0; width: 100%; padding: 15px; text-align: center; display: none; z-index: 1000; }
        .success { background: #d1e7dd; color: #0f5132; }
        .error { background: #f8d7da; color: #842029; }
        
        .objekt-item { display: flex; align-items: center; padding: 15px 0; border-bottom: 1px solid var(--border); }
        .objekt-item input[type="checkbox"] { margin-right: 15px; transform: scale(1.3); }
        
        a.back { display: block; text-align: center; margin-top: 30px; color: var(--primary); text-decoration: none; font-size: 1.1em; }

        @media (max-width: 767px) {
            .sidebar { position: fixed; top: 0; left: 0; width: 100%; height: 100%; transform: translateX(100%); z-index: 9; }
            .sidebar.open { transform: translateX(0); }
            .container { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div id="message"></div>
    <div class="container">
        <nav class="sidebar">
            <div class="sidebar-header"><h1>Gruppen & Ringe</h1></div>
            <ul>
                <li><a href="index.html">Suchseite</a></li>
                <li><a href="#create" class="active" onclick="showSection('create')">Neues Objekt</a></li>
                <li><a href="#upload" onclick="showSection('upload')">Daten hochladen</a></li>
                <li><a href="#delete" onclick="showSection('delete')">Objekte löschen</a></li>
            </ul>
        </nav>
        <main class="main">
            <section id="create" class="section active">
                <h2>Neues Objekt hinzufügen</h2>
                <input type="text" id="code" placeholder="Objekt-Code (z.B. ABC123)">
                <button class="btn-add" onclick="addObject()">Objekt speichern</button>
            </section>

            <section id="upload" class="section">
                <h2>Datendatei hochladen</h2>
                <label>Objekt wählen:</label>
                <select id="linkedObjekte"></select>
                <label>Esser CSV Datei:</label>
                <input type="file" id="uploadFile" accept=".csv">
                <button class="btn-upload" id="uploadBtn" onclick="uploadFileProcess()">
                    <span class="spinner" id="uploadSpinner"></span>
                    <span>Hochladen & Verarbeiten</span>
                </button>
            </section>

            <section id="delete" class="section">
                <h2>Objekte löschen</h2>
                <ul id="objektList" style="list-style:none; padding:0;"></ul>
                <button class="btn-delete" onclick="deleteObject()" id="deleteBtn" disabled>Löschen</button>
            </section>
        </main>
    </div>

    <script>
        const API_BASE = 'https://hab-api-functions-agf8hya9f2cgdeaf.westus2-01.azurewebsites.net/api';

        function showSection(id) {
            document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if (id === 'upload' || id === 'delete') loadObjekte();
        }

        async function loadObjekte() {
            try {
                const res = await fetch(`${API_BASE}/get-objects`);
                const objects = await res.json();
                const list = document.getElementById('objektList');
                const select = document.getElementById('linkedObjekte');
                list.innerHTML = ''; select.innerHTML = '';
                objects.forEach(obj => {
                    const opt = document.createElement('option');
                    opt.value = obj.id;
                    opt.textContent = `${obj.display} (${obj.id})`;
                    select.appendChild(opt);
                    const li = document.createElement('li');
                    li.className = 'objekt-item';
                    li.innerHTML = `<input type="checkbox" name="del" value="${obj.id}" onchange="toggleDelBtn()"> ${obj.display}`;
                    list.appendChild(li);
                });
            } catch (e) { showMessage('Fehler beim Laden', false); }
        }

        function toggleDelBtn() {
            const checked = document.querySelectorAll('input[name="del"]:checked');
            document.getElementById('deleteBtn').disabled = checked.length === 0;
        }

        async function uploadFileProcess() {
            const id = document.getElementById('linkedObjekte').value;
            const fileInput = document.getElementById('uploadFile');
            const btn = document.getElementById('uploadBtn');
            const spinner = document.getElementById('uploadSpinner');

            if (!id || fileInput.files.length === 0) return showMessage('Bitte alles ausfüllen', false);

            btn.disabled = true;
            spinner.style.display = 'block';

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const processedData = csvToJSON(e.target.result);
                    await performUpload(id, processedData, false);
                } catch (err) { 
                    showMessage(err.message, false); 
                    btn.disabled = false;
                    spinner.style.display = 'none';
                }
            };
            reader.readAsText(fileInput.files[0], 'ISO-8859-1');
        }

        async function performUpload(id, data, override) {
            const btn = document.getElementById('uploadBtn');
            const spinner = document.getElementById('uploadSpinner');

            try {
                const res = await fetch(`${API_BASE}/upload-data`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id, data, override })
                });

                if (res.status === 409) {
                    if (confirm(`Überschreiben?`)) await performUpload(id, data, true);
                    else { btn.disabled = false; spinner.style.display = 'none'; }
                } else {
                    showMessage(res.ok ? 'Erfolgreich!' : 'Fehler', res.ok);
                    btn.disabled = false;
                    spinner.style.display = 'none';
                    if(res.ok) document.getElementById('uploadFile').value = '';
                }
            } catch (e) { 
                showMessage('Upload-Fehler', false); 
                btn.disabled = false;
                spinner.style.display = 'none';
            }
        }

        function csvToJSON(csvText) {
            const lines = csvText.split(/\r?\n/);
            if (lines.length < 4) return [];
            const delimiter = lines[2].includes(';') ? ';' : ',';
            const headers = lines[2].split(delimiter).map(h => h.replace(/["\r]/g, '').trim());
            
            return lines.slice(3).filter(line => line.trim()).map(line => {
                const values = line.split(delimiter);
                const obj = {};
                headers.forEach((header, i) => {
                    let key = header.replace(/\./g, '').trim();
                    if (key === "Nr") key = "Gruppe";
                    else if (key === "Zusatztext") key = "Installationsort";
                    else if (key === "Installationsort") key = "Ring";
                    
                    let val = values[i] ? values[i].replace(/["\r]/g, '').trim() : "";
                    obj[key] = val;
                });
                return obj;
            });
        }

        async function addObject() {
            const code = document.getElementById('code').value.trim();
            try {
                const res = await fetch(`${API_BASE}/add-object`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code })
                });
                if (res.ok) { showMessage('Objekt hinzugefügt', true); loadObjekte(); }
            } catch (e) { showMessage('Fehler', false); }
        }

        async function deleteObject() {
            const id = document.querySelector('input[name="del"]:checked').value;
            if(!confirm('Löschen?')) return;
            try {
                await fetch(`${API_BASE}/delete-object`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id })
                });
                loadObjekte();
            } catch (e) { showMessage('Fehler', false); }
        }

        function showMessage(text, success) {
            const msg = document.getElementById('message');
            msg.textContent = text;
            msg.className = success ? 'success' : 'error';
            msg.style.display = 'block';
            setTimeout(() => msg.style.display = 'none', 3000);
        }

        window.onload = loadObjekte;
    </script>
</body>
</html>