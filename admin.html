<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Admin – Objekte verwalten</title>
    <style>
        :root {
            --bg: #f8f9fa;
            --text: #212529;
            --card-bg: #ffffff;
            --border: #dee2e6;
            --primary: #0d6efd;
            --success: #198754;
            --danger: #dc3545;
            --help: #6c757d;
        }
        body.dark-mode {
            --bg: #121212;
            --text: #e9ecef;
            --card-bg: #1e1e1e;
            --border: #495057;
            --help: #adb5bd;
        }
        body {
            font-family: Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            transition: background-color 0.3s, color 0.3s;
        }
        .container {
            display: flex;
            min-height: 100vh;
        }
        .sidebar {
            width: 250px;
            background: var(--card-bg);
            padding: 20px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            transition: transform 0.3s;
            border-right: 1px solid var(--border);
        }
        .sidebar-header h1 { font-size: 1.8em; margin: 0; }
        .sidebar-header h2 { font-size: 1.2em; margin: 10px 0 30px; color: var(--help); }
        .sidebar ul { list-style: none; padding: 0; }
        .sidebar li { margin-bottom: 40px; border-left: 4px solid transparent; padding-left: 10px; }
        .sidebar li:nth-child(1) { border-left-color: #dc3545; }
        .sidebar li:nth-child(3) { border-left-color: #0d6efd; }
        .sidebar a { display: block; text-decoration: none; color: var(--text); transition: color 0.2s; }
        .sidebar a:hover, .sidebar a.active { color: var(--primary); }
        .main { flex: 1; padding: 20px; max-width: 800px; margin: 0 auto; }
        .section { display: none; background: var(--card-bg); border: 1px solid var(--border); border-radius: 10px; padding: 20px; margin-bottom: 30px; }
        .section.active { display: block; }
        h1, h2 { color: var(--primary); text-align: center; }
        label { display: block; margin: 15px 0 5px; font-weight: bold; }
        input[type="text"], input[type="file"], select { width: 100%; padding: 10px; box-sizing: border-box; background: var(--card-bg); color: var(--text); border: 1px solid var(--border); border-radius: 5px; }
        button { width: 100%; padding: 12px; margin-top: 15px; border: none; border-radius: 5px; font-size: 1.1em; cursor: pointer; }
        .btn-add { background: var(--success); color: white; }
        .btn-upload { background: var(--primary); color: white; }
        .btn-delete { background: var(--danger); color: white; }
        .btn-delete:disabled { opacity: 0.5; cursor: not-allowed; }
        .help { font-size: 0.9em; color: var(--help); margin-top: 10px; }
        #message { position: fixed; top: 0; left: 0; width: 100%; padding: 15px; text-align: center; display: none; z-index: 1000; }
        .success { background: #d1e7dd; color: #0f5132; }
        .error { background: #f8d7da; color: #842029; }
        .objekt-item { display: flex; align-items: center; padding: 15px 0; border-bottom: 1px solid var(--border); }
        .objekt-item input[type="checkbox"] { margin-right: 15px; transform: scale(1.3); }
        .objekt-title { font-weight: bold; font-size: 1.1em; }
        .objekt-code { font-size: 0.9em; color: var(--help); margin-left: 8px; }
        a.back { display: block; text-align: center; margin-top: 30px; color: var(--primary); text-decoration: none; font-size: 1.1em; }
        .hamburger { display: none; position: fixed; top: 10px; right: 10px; z-index: 10; cursor: pointer; width: 25px; height: 20px; }
        .hamburger span { display: block; width: 25px; height: 3px; background: var(--text); position: absolute; transition: 0.3s; }
        .hamburger span:nth-child(1) { top: 0; }
        .hamburger span:nth-child(2) { top: 8px; }
        .hamburger span:nth-child(3) { top: 16px; }
        .hamburger.active span:nth-child(1) { transform: rotate(45deg); top: 8px; }
        .hamburger.active span:nth-child(2) { opacity: 0; }
        .hamburger.active span:nth-child(3) { transform: rotate(-45deg); top: 8px; }
        @media (max-width: 767px) {
            .sidebar { position: fixed; top: 0; left: 0; width: 100%; height: 100%; transform: translateX(100%); z-index: 9; }
            .sidebar.open { transform: translateX(0); }
            .hamburger { display: block; }
            .container { flex-direction: column; }
            .main { padding: 10px; }
            button { width: 100%; }
        }
    </style>
</head>
<body>
    <div id="message"></div>
    <div class="hamburger" onclick="toggleSidebar()">
        <span></span><span></span><span></span>
    </div>
    <div class="container">
        <nav class="sidebar">
            <div class="sidebar-header"><h1>Gruppen & Ringe</h1></div>
            <h2>Admin: Objekte verwalten</h2>
            <ul>
                <li><a href="index.html">Suchseite</a></li>
                <li><a href="#create" class="active" onclick="showSection('create')">Neues Objekt hinzufügen</a></li>
                <li><a href="#upload" onclick="showSection('upload')">Datendatei hochladen</a></li>
                <li><a href="#delete" onclick="showSection('delete')">Objekte löschen</a></li>
            </ul>
        </nav>
        <main class="main">
            <h1>Admin: Objekte verwalten</h1>
            
            <section id="create" class="section active">
                <h2>Neues Objekt hinzufügen</h2>
                <label for="code">Objekt-Code (alphanumerisch):</label>
                <input type="text" id="code" placeholder="z.B. ABC123" required>
                <button class="btn-add" onclick="addObject()">Objekt hinzufügen</button>
                <div class="help">Nach dem Hinzufügen erscheint das Objekt sofort in der Liste.</div>
            </section>

            <section id="upload" class="section">
                <h2>Datendatei hochladen</h2>
                <label for="linkedObjekte">Objekt auswählen:</label>
                <select id="linkedObjekte"><!-- Populated dynamically --></select>
                <label for="source">Datenquelle:</label>
                <select id="source">
                    <option value="esser">Esser Tools 8000 (CSV)</option>
                    <option value="hekatron">Hekatron</option>
                </select>
                <label for="uploadFile">Datei auswählen:</label>
                <input type="file" id="uploadFile" accept=".csv,.json" required>
                <button class="btn-upload" onclick="uploadFileProcess()">Hochladen</button>
            </section>

            <section id="delete" class="section">
                <h2>Objekte löschen</h2>
                <ul class="objekt-list" id="objektList"><!-- Populated dynamically --></ul>
                <button class="btn-delete" onclick="deleteObject()" id="deleteBtn" disabled>Ausgewähltes löschen</button>
            </section>

            <a class="back" href="index.html">← Zurück zur Suchseite</a>
        </main>
    </div>

    <script>
        const API_BASE = 'https://hab-api-functions-agf8hya9f2cgdeaf.westus2-01.azurewebsites.net/api';

        // Dark mode sync
        if (localStorage.getItem('darkMode') === 'enabled') document.body.classList.add('dark-mode');

        function toggleSidebar() {
            document.querySelector('.sidebar').classList.toggle('open');
            document.querySelector('.hamburger').classList.toggle('active');
        }

        function showSection(id) {
            document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.sidebar a').forEach(a => a.classList.remove('active'));
            document.querySelector(`.sidebar a[href="#${id}"]`).classList.add('active');
            if (window.innerWidth < 768) toggleSidebar();
            if (id === 'upload' || id === 'delete') loadObjekte();
        }

        async function loadObjekte() {
            try {
                const res = await fetch(`${API_BASE}/get-objects`);
                const objects = await res.json();
                
                const list = document.getElementById('objektList');
                const select = document.getElementById('linkedObjekte');
                list.innerHTML = '';
                select.innerHTML = '';

                if (objects.length === 0) {
                    list.innerHTML = '<li>Keine Objekte vorhanden</li>';
                    return;
                }

                objects.forEach(obj => {
                    // For upload select
                    const opt = document.createElement('option');
                    opt.value = obj.id;
                    opt.textContent = `${obj.display} (${obj.id})`;
                    select.appendChild(opt);

                    // For delete list
                    const li = document.createElement('li');
                    li.className = 'objekt-item';
                    li.innerHTML = `
                        <input type="checkbox" name="delete-check" value="${obj.id}" onchange="handleCheckboxChange(this)">
                        <div class="objekt-title">${obj.display}</div>
                        <div class="objekt-code">(${obj.id})</div>
                    `;
                    list.appendChild(li);
                });
                document.getElementById('deleteBtn').disabled = true;
            } catch (e) {
                console.error(e);
                showMessage('Fehler beim Laden der Objekte', false);
            }
        }

        function handleCheckboxChange(checkbox) {
            const checkboxes = document.querySelectorAll('input[name="delete-check"]');
            if (checkbox.checked) {
                checkboxes.forEach(cb => { if (cb !== checkbox) cb.disabled = true; });
                document.getElementById('deleteBtn').disabled = false;
            } else {
                checkboxes.forEach(cb => cb.disabled = false);
                document.getElementById('deleteBtn').disabled = true;
            }
        }

        async function addObject() {
            const input = document.getElementById('code');
            const code = input.value.trim();
            if (!code) return showMessage('Bitte Code eingeben', false);

            try {
                const res = await fetch(`${API_BASE}/add-object`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code })
                });
                if (res.ok) {
                    showMessage('Objekt hinzugefügt', true);
                    input.value = '';
                    loadObjekte();
                } else {
                    showMessage(await res.text(), false);
                }
            } catch (e) { showMessage('Netzwerkfehler', false); }
        }

        async function deleteObject() {
            const selected = document.querySelector('input[name="delete-check"]:checked');
            if (!selected) return;
            const id = selected.value;

            if (!confirm(`Objekt '${id}' und zugehörige Daten wirklich löschen?`)) return;

            try {
                const res = await fetch(`${API_BASE}/delete-object`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id })
                });
                if (res.ok) {
                    showMessage('Objekt gelöscht', true);
                    loadObjekte();
                } else {
                    showMessage(await res.text(), false);
                }
            } catch (e) { showMessage('Fehler beim Löschen', false); }
        }

        function showMessage(text, success) {
            const msg = document.getElementById('message');
            msg.textContent = text;
            msg.className = success ? 'success' : 'error';
            msg.style.display = 'block';
            setTimeout(() => msg.style.display = 'none', 4000);
        }

        async function uploadFileProcess() {
    const selectedId = document.getElementById('linkedObjekte').value;
    const fileInput = document.getElementById('uploadFile');
    
    if (!selectedId || fileInput.files.length === 0) {
        return showMessage('Bitte Objekt wählen und Datei auswählen.', false);
    }

    const file = fileInput.files[0];
    const reader = new FileReader();

    reader.onload = async (e) => {
        const text = e.target.result;
        try {
            // 1. Convert CSV to JSON
            const processedData = csvToJSON(text);
            
            if (processedData.length === 0) {
                throw new Error("Die Datei scheint leer zu sein oder das Format ist ungültig.");
            }

            // 2. Log result for verification (Check your browser console)
            console.log("Verarbeitete Daten:", processedData);
            
            // 3. For now, just show a success message that processing finished
            showMessage(`Verarbeitung abgeschlossen: ${processedData.length} Zeilen erkannt.`, true);
            
            // Note: We will add the Backend Upload & Override logic in the next step.
            
        } catch (err) {
            console.error(err);
            showMessage("Fehler bei der Verarbeitung: " + err.message, false);
        }
    };

    reader.readAsText(file, 'ISO-8859-1'); // Esser files often use Western encoding
}

function csvToJSON(csvText) {
    const lines = csvText.split(/\r?\n/);
    if (lines.length < 4) return [];

    // Esser Format: Line 3 is headers (Index 2), Data starts Line 4 (Index 3)
    const delimiter = lines[2].includes(';') ? ';' : ',';
    const headers = lines[2].split(delimiter).map(h => h.trim());

    const result = [];
    for (let i = 3; i < lines.length; i++) {
        if (!lines[i].trim()) continue;

        const obj = {};
        const currentline = lines[i].split(delimiter);

        headers.forEach((header, index) => {
            let value = currentline[index] ? currentline[index].trim() : "";
            
            // Clean Header/Key names (Remove dots and extra spaces)
            let key = header.replace(/\./g, '').trim();

            // Apply Mapping
            if (key === "Nr") key = "Gruppe";
            else if (key === "Zusatztext") key = "Installationsort";
            else if (key === "Installationsort") key = "Ring";
            
            // Add to object
            obj[key] = value;
        });
        result.push(obj);
    }
    return result;
}

        window.onload = () => { loadObjekte(); showSection('create'); };
    </script>
</body>
</html>