<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Admin ‚Äì Objekte verwalten</title>
    <style>
        :root {
            --bg: #f8f9fa;
            --text: #212529;
            --card-bg: #ffffff;
            --border: #dee2e6;
            --primary: #0d6efd;
            --success: #198754;
            --danger: #dc3545;
            --help: #6c757d;
        }
        body.dark-mode {
            --bg: #121212;
            --text: #e9ecef;
            --card-bg: #1e1e1e;
            --border: #495057;
            --help: #adb5bd;
        }
        body {
            font-family: Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            transition: background-color 0.3s, color 0.3s;
            overflow-x: hidden;
        }
        .container { display: flex; min-height: 100vh; }
        
        /* Sidebar Styles */
        .sidebar {
            width: 250px;
            background: var(--card-bg);
            padding: 20px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
            border-right: 1px solid var(--border);
            z-index: 1000;
            position: relative;
        }
        .sidebar-header { padding-top: 40px; } /* Space for hamburger/close button */
        .sidebar-header h1 { font-size: 1.6em; margin: 0; color: var(--primary); }
        .sidebar ul { list-style: none; padding: 0; margin-top: 30px; }
        .sidebar li { margin-bottom: 25px; border-left: 4px solid transparent; padding-left: 10px; }
        .sidebar a { display: flex; align-items: center; gap: 10px; text-decoration: none; color: var(--text); font-weight: bold; }
        .sidebar a:hover, .sidebar a.active { color: var(--primary); }
        
        /* Sidebar Close Button (Mobile Only) */
        .sidebar-close {
            display: none;
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 2rem;
            color: var(--danger);
            cursor: pointer;
            line-height: 1;
        }

        /* Main Content */
        .main { flex: 1; padding: 20px; max-width: 800px; margin: 0 auto; position: relative; }
        .section { display: none; background: var(--card-bg); border: 1px solid var(--border); border-radius: 10px; padding: 25px; margin-bottom: 30px; }
        .section.active { display: block; }
        
        /* Header Actions */
        .header-actions { display: flex; justify-content: flex-end; padding: 10px; }
        .icon-btn { background: none; border: none; cursor: pointer; font-size: 1.5rem; color: var(--text); }

        /* Form Elements */
        label { display: block; margin: 15px 0 5px; font-weight: bold; font-size: 0.9em; }
        input[type="text"], select, input[type="file"] { 
            width: 100%; padding: 12px; box-sizing: border-box; 
            background: var(--card-bg); color: var(--text); 
            border: 1px solid var(--border); border-radius: 8px; 
            text-transform: uppercase;
        }
        
        /* Buttons */
        button { 
            width: 100%; padding: 14px; margin-top: 20px; border: none; border-radius: 8px; 
            font-size: 1em; font-weight: bold; cursor: pointer; 
            display: flex; justify-content: center; align-items: center; gap: 10px; 
        }
        .btn-add { background: var(--success); color: white; }
        .btn-upload { background: var(--primary); color: white; }
        .btn-delete { background: var(--danger); color: white; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Hamburger Menu */
        .hamburger {
            display: none; position: fixed; top: 15px; left: 15px; 
            z-index: 900; cursor: pointer; width: 30px; height: 25px;
        }
        .hamburger span { display: block; width: 100%; height: 4px; background: var(--text); margin-bottom: 5px; transition: 0.3s; }

        /* Utilities */
        #message { position: fixed; top: 0; left: 0; width: 100%; padding: 15px; text-align: center; display: none; z-index: 2000; font-weight: bold; }
        .success { background: #d1e7dd; color: #0f5132; }
        .error { background: #f8d7da; color: #842029; }
        .objekt-item { display: flex; align-items: center; padding: 12px; border-bottom: 1px solid var(--border); }
        .objekt-item input { margin-right: 15px; width: 20px; height: 20px; }
        .spinner { width: 18px; height: 18px; border: 3px solid rgba(255,255,255,.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s infinite linear; display: none; }
        @keyframes spin { to { transform: rotate(360deg); } }

        @media (max-width: 767px) {
            .hamburger { display: block; }
            .sidebar-close { display: block; }
            .sidebar { position: fixed; left: 0; top: 0; height: 100%; transform: translateX(-100%); width: 280px; }
            .sidebar.open { transform: translateX(0); }
            .main { padding-top: 60px; }
        }
    </style>
</head>
<body>
    <div id="message"></div>
    
    <div class="hamburger" id="hamburger" onclick="toggleSidebar()">
        <span></span><span></span><span></span>
    </div>

    <div class="container">
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-close" onclick="toggleSidebar()">&times;</div>
            <div class="sidebar-header"><h1>Admin</h1></div>
            <ul>
                <li><a href="index.html">üîç Suche</a></li>
                <li><a href="#create" class="active" onclick="showSection('create')">‚ûï Neues Objekt</a></li>
                <li><a href="#upload" onclick="showSection('upload')">üì§ Daten Upload</a></li>
                <li><a href="#delete" onclick="showSection('delete')">üóëÔ∏è L√∂schen</a></li>
            </ul>
        </nav>

        <main class="main">
            <div class="header-actions">
                <button id="theme-toggle" class="icon-btn">üåô</button>
            </div>

            <section id="create" class="section active">
                <h2>Neues Objekt hinzuf√ºgen</h2>
                <label>Objekt-Code:</label>
                <input type="text" id="code" placeholder="NUR BUCHSTABEN & ZAHLEN" autocomplete="off" spellcheck="false">
                <button class="btn-add" onclick="addObject()">Objekt speichern</button>
            </section>

            <section id="upload" class="section">
                <h2>Datendatei hochladen</h2>
                <label>Objekt w√§hlen:</label>
                <select id="linkedObjekte"></select>
                <label>Esser CSV Datei w√§hlen:</label>
                <input type="file" id="uploadFile" accept=".csv" autocomplete="off">
                <button class="btn-upload" id="uploadBtn" onclick="uploadFileProcess()">
                    <div class="spinner" id="uploadSpinner"></div>
                    <span>Hochladen</span>
                </button>
            </section>

            <section id="delete" class="section">
                <h2>Objekt l√∂schen</h2>
                <ul id="objektList" style="list-style:none; padding:0;"></ul>
                <button class="btn-delete" onclick="deleteObject()" id="deleteBtn" disabled>Markiertes Objekt l√∂schen</button>
            </section>
        </main>
    </div>

    <script>
        const API_BASE = 'https://hab-api-functions-agf8hya9f2cgdeaf.westus2-01.azurewebsites.net/api';

        // Dark Mode
        const themeToggle = document.getElementById('theme-toggle');
        if (localStorage.getItem('darkMode') === 'enabled') {
            document.body.classList.add('dark-mode');
            themeToggle.textContent = '‚òÄÔ∏è';
        }
        themeToggle.addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            themeToggle.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
            localStorage.setItem('darkMode', isDark ? 'enabled' : 'disabled');
        });

        // Input Enforcement
        const codeInput = document.getElementById('code');
        codeInput.addEventListener('input', (e) => {
            e.target.value = e.target.value.replace(/[^a-zA-Z0-9]/g, '').toUpperCase();
        });

        // Sidebar Controls
        const sidebar = document.getElementById('sidebar');
        function toggleSidebar() {
            sidebar.classList.toggle('open');
        }

        // Swipe Left to Close Sidebar
        let touchStartX = 0;
        sidebar.addEventListener('touchstart', (e) => {
            touchStartX = e.changedTouches[0].screenX;
        }, {passive: true});

        sidebar.addEventListener('touchend', (e) => {
            let touchEndX = e.changedTouches[0].screenX;
            if (touchStartX - touchEndX > 50) { // If swiped left more than 50px
                sidebar.classList.remove('open');
            }
        }, {passive: true});

        function showSection(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.sidebar a').forEach(a => a.classList.remove('active'));
            document.querySelector(`a[href="#${id}"]`).classList.add('active');
            if(window.innerWidth < 768) sidebar.classList.remove('open');
            if(id !== 'create') loadObjekte();
        }

        async function loadObjekte() {
            try {
                const res = await fetch(`${API_BASE}/get-objects`);
                const objects = await res.json();
                const list = document.getElementById('objektList');
                const select = document.getElementById('linkedObjekte');
                list.innerHTML = ''; select.innerHTML = '';
                objects.forEach(obj => {
                    const opt = document.createElement('option');
                    opt.value = obj.id;
                    opt.textContent = `${obj.display} (${obj.id})`;
                    select.appendChild(opt);
                    const li = document.createElement('li');
                    li.className = 'objekt-item';
                    li.innerHTML = `<input type="checkbox" name="del" value="${obj.id}" onchange="toggleDelBtn()"> <strong>${obj.display}</strong>`;
                    list.appendChild(li);
                });
            } catch (e) { showMessage('Fehler beim Laden', false); }
        }

        function toggleDelBtn() {
            const checked = document.querySelectorAll('input[name="del"]:checked');
            document.getElementById('deleteBtn').disabled = checked.length === 0;
            if(checked.length > 1) checked[0].checked = false;
        }

        async function addObject() {
            const code = codeInput.value.trim();
            if(!code) return showMessage('Code erforderlich', false);
            try {
                const res = await fetch(`${API_BASE}/add-object`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ code })
                });
                if(res.ok) { showMessage('Erfolgreich gespeichert', true); codeInput.value = ''; }
                else showMessage(await res.text(), false);
            } catch (e) { showMessage('Fehler', false); }
        }

        async function uploadFileProcess() {
            const id = document.getElementById('linkedObjekte').value;
            const fileInput = document.getElementById('uploadFile');
            const btn = document.getElementById('uploadBtn');
            const spinner = document.getElementById('uploadSpinner');

            if (!id || fileInput.files.length === 0) return showMessage('Daten unvollst√§ndig', false);

            btn.disabled = true;
            spinner.style.display = 'block';

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = csvToJSON(e.target.result);
                    await performUpload(id, data, false);
                } catch (err) { showMessage(err.message, false); resetBtn(); }
            };
            reader.readAsText(fileInput.files[0], 'ISO-8859-1');
        }

        async function performUpload(id, data, override) {
            try {
                const res = await fetch(`${API_BASE}/upload-data`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ id, data, override })
                });
                if (res.status === 409) {
                    if (confirm('Datei existiert. √úberschreiben?')) await performUpload(id, data, true);
                    else resetBtn();
                } else {
                    showMessage(res.ok ? 'Datei hochgeladen!' : 'Fehler', res.ok);
                    resetBtn();
                    if(res.ok) document.getElementById('uploadFile').value = '';
                }
            } catch (e) { showMessage('Upload fehlgeschlagen', false); resetBtn(); }
        }

        function resetBtn() {
            document.getElementById('uploadBtn').disabled = false;
            document.getElementById('uploadSpinner').style.display = 'none';
        }

        function csvToJSON(csvText) {
            const lines = csvText.split(/\r?\n/);
            if (lines.length < 4) return [];
            const delimiter = lines[2].includes(';') ? ';' : ',';
            const headers = lines[2].split(delimiter).map(h => {
                let k = h.replace(/["\r]/g, '').replace(/\./g, '').trim();
                if(k === "Nr") return "Gruppe";
                if(k === "Zusatztext") return "Installationsort";
                if(k === "Installationsort") return "Ring";
                return k;
            });
            return lines.slice(3).filter(l => l.trim()).map(l => {
                const v = l.split(delimiter);
                const o = {};
                headers.forEach((k, i) => {
                    let val = v[i] ? v[i].replace(/["\r¬¥¬∞%()]/g, '').replace(/[@\/.]/g, ' ').replace(/\s+/g, ' ').trim() : "";
                    o[k] = val;
                });
                return o;
            });
        }

        async function deleteObject() {
            const sel = document.querySelector('input[name="del"]:checked');
            if(!sel || !confirm('Endg√ºltig l√∂schen?')) return;
            try {
                const res = await fetch(`${API_BASE}/delete-object`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ id: sel.value })
                });
                if(res.ok) { showMessage('Gel√∂scht', true); loadObjekte(); }
            } catch (e) { showMessage('Fehler', false); }
        }

        function showMessage(t, s) {
            const m = document.getElementById('message');
            m.textContent = t;
            m.className = s ? 'success' : 'error';
            m.style.display = 'block';
            setTimeout(() => m.style.display = 'none', 3000);
        }

        window.onload = loadObjekte;
    </script>
</body>
</html>