<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Suche - Meldergruppen & Ringe</title>
    <link rel="manifest" href="manifest.json">
    <!-- Dependencies -->
    <script src="auth-guard.js"></script>
    <script src="webauthn-json.js"></script>
    <style>
        :root {
            --bg-color: #f8f9fa; --text-color: #212529; --card-bg: #ffffff; --border-color: #dee2e6;
            --primary-color: #0d6efd; --secondary-text: #6c757d; --danger: #dc3545; --success: #198754;
        }
        body.dark-mode {
            --bg-color: #121212; --text-color: #e9ecef; --card-bg: #1e1e1e; --border-color: #495057; --secondary-text: #adb5bd;
        }
        body {
            font-family: -apple-system, system-ui, sans-serif; background-color: var(--bg-color);
            color: var(--text-color); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh;
            transition: background-color 0.3s; overflow-x: hidden;
        }

        /* Fixed Card Container */
        .container { 
            width: 100%; max-width: 1000px; 
            background: var(--card-bg); 
            padding: 30px; 
            border-radius: 16px; 
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); 
            border: 1px solid var(--border-color);
            box-sizing: border-box;
            margin-top: 60px; /* Space for hamburger */
        }

        /* Sidebar Styles */
        .sidebar {
            width: 280px; background: var(--card-bg); padding: 20px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1); transition: transform 0.3s ease;
            border-right: 1px solid var(--border-color); z-index: 1200;
            display: flex; flex-direction: column; position: fixed; left: 0; top: 0; height: 100%;
            transform: translateX(-100%);
        }
        .sidebar.open { transform: translateX(0); }
        .sidebar-header { padding-top: 40px; margin-bottom: 30px; }
        .sidebar-header h2 { font-size: 1.4em; margin: 0; color: var(--primary-color); }
        
        .sidebar ul { list-style: none; padding: 0; flex-grow: 1; }
        .sidebar li { margin-bottom: 25px; }
        .sidebar a { display: flex; align-items: center; gap: 12px; text-decoration: none; color: var(--text-color); font-weight: bold; }
        .menu-icon { width: 28px; text-align: center; display: inline-block; font-size: 1.2rem; }

        .sidebar-footer { padding: 20px 0 30px; border-top: 1px solid var(--border-color); }
        .btn-logout { 
            width: 100%; background: var(--danger); color: white; border: none; 
            padding: 14px; border-radius: 10px; cursor: pointer; font-weight: bold; font-size: 1rem;
        }

        /* Settings Items */
        .setting-item { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; font-size: 0.9rem; font-weight: 600; }
        .setting-item input { width: auto; height: auto; }

        /* UI Elements */
        h1 { font-size: 1.8rem; margin-bottom: 30px; text-align: center; color: var(--primary-color); }
        #offline-badge { display: none; background: var(--danger); color: white; padding: 4px 10px; border-radius: 20px; font-size: 0.7rem; margin-left: 10px; vertical-align: middle; }
        body.is-offline #offline-badge { display: inline-block; }

        .controls-grid { display: grid; grid-template-columns: 1fr; gap: 20px; margin-bottom: 20px; }
        @media (min-width: 768px) { .controls-grid { grid-template-columns: repeat(3, 1fr); } }

        label { font-weight: 600; margin-bottom: 8px; display: block; font-size: 0.85rem; }
        select, input { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 10px; background-color: var(--bg-color); color: var(--text-color); font-size: 1rem; height: 50px; box-sizing: border-box; }
        
        .button-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; max-width: 400px; margin: 10px auto 30px; }
        .btn { height: 50px; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; color: white; font-size: 1rem; }
        .btn-search { background-color: var(--primary-color); }
        .btn-clear { background-color: #6c757d; }

        #status { text-align: center; color: var(--secondary-text); font-style: italic; margin-bottom: 20px; min-height: 1.2em;}

        /* Search Results */
        .table-wrapper { margin-top: 20px; overflow-x: auto; width: 100%; }
        .hidden { display: none !important; }
        table { width: 100%; border-collapse: collapse; background: var(--card-bg); border-radius: 12px; overflow: hidden; }
        th, td { padding: 14px; text-align: left; border-bottom: 1px solid var(--border-color); }
        th { background: var(--bg-color); color: var(--primary-color); font-weight: 600; }

        .btn-details { background-color: #6c757d; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.8rem; }
        .details-pane { display: none; padding: 15px; background: var(--bg-color); font-size: 0.9rem; border-radius: 8px; margin-top: 10px; border: 1px solid var(--border-color); line-height: 1.6; }

        /* Icons/Hamburger */
        .hamburger { position: fixed; top: 18px; left: 18px; z-index: 1300; cursor: pointer; width: 30px; }
        .hamburger span { display: block; width: 100%; height: 3px; background: var(--text-color); margin-bottom: 6px; border-radius: 4px; }
        .sidebar-close { position: absolute; top: 15px; right: 15px; font-size: 2rem; color: var(--danger); cursor: pointer; }

        @media (min-width: 768px) { #mobile-cards { display: none; } }
        @media (max-width: 767px) { .table-wrapper { display: none; } }
        .result-item { background: var(--card-bg); padding: 18px; border-radius: 12px; margin-bottom: 15px; border: 1px solid var(--border-color); }
        .card-row { display: flex; justify-content: space-between; margin-bottom: 6px; }
        .card-label { font-weight: bold; color: var(--secondary-text); font-size: 0.8rem; }
    </style>
</head>
<body>

    <div id="message"></div>
    <div class="hamburger" onclick="toggleSidebar()"><span></span><span></span><span></span></div>

    <nav class="sidebar" id="sidebar">
        <div class="sidebar-close" onclick="toggleSidebar()">&times;</div>
        <div class="sidebar-header"><h2>Einstellungen</h2></div>
        
        <ul>
            <li id="admin-nav" style="display:none;"><a href="admin.html"><span class="menu-icon">‚öôÔ∏è</span> Admin Panel</a></li>
        </ul>

        <div class="sidebar-footer">
            <div class="setting-item">
                <span>üåô Dunkelmodus</span>
                <input type="checkbox" id="dark-toggle" onchange="toggleTheme()">
            </div>
            
            <div class="setting-item">
                <span>üîí Biometrie</span>
                <input type="checkbox" id="bio-toggle" onchange="handleBioToggle(this)">
            </div>
            <span id="bio-status" style="font-size:0.7rem; color:var(--help); margin-bottom:15px; display:block;">Pr√ºfe Modul...</span>

            <button class="btn-logout" onclick="logout()">Abmelden</button>
        </div>
    </nav>

    <div class="container">
        <h1>Meldergruppen & Ringe <span id="offline-badge">OFFLINE</span></h1>

        <div class="controls">
            <div class="controls-grid">
                <div>
                    <label>Objekt:</label>
                    <select id="object" onchange="loadData()"><option value="">Laden...</option></select>
                </div>
                <div>
                    <label>Suchen nach:</label>
                    <select id="searchType" onchange="updateSearchUI()">
                        <option value="gruppe">Meldergruppe</option>
                        <option value="ring">Ring</option>
                    </select>
                </div>
                <div>
                    <label id="searchLabel">Gruppe eingeben:</label>
                    <input type="text" id="search" placeholder="z.B. 101" inputmode="numeric" autocomplete="off">
                </div>
            </div>
            <div class="button-row">
                <button class="btn btn-search" onclick="filterResults()">Suchen</button>
                <button class="btn btn-clear" onclick="clearSearch()">Neu</button>
            </div>
        </div>

        <div id="status">Warte auf Auswahl...</div>

        <!-- Hidden table wrapper by default -->
        <div id="table-wrapper" class="table-wrapper hidden">
            <table>
                <thead>
                    <tr><th>Gruppe</th><th>Installationsort</th><th>Ring</th><th>AnzMelder</th><th>Details</th></tr>
                </thead>
                <tbody id="table-body"></tbody>
            </table>
        </div>
        <div id="mobile-cards" class="hidden"></div>
    </div>

    <script>
        const API_BASE = 'https://hab-api-functions-agf8hya9f2cgdeaf.westus2-01.azurewebsites.net/api';
        let data = [];

        // 1. Sidebar & Settings Logic
        const sidebar = document.getElementById('sidebar');
        function toggleSidebar() { sidebar.classList.toggle('open'); }
        
        let sx = 0;
        sidebar.addEventListener('touchstart', e => sx = e.touches[0].clientX);
        sidebar.addEventListener('touchend', e => { if (sx - e.changedTouches[0].clientX > 60) sidebar.classList.remove('open'); });

        function logout() { localStorage.removeItem('token'); localStorage.removeItem('role'); window.location.href = 'login.html'; }

        function toggleTheme() {
            const isDark = document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', isDark ? 'enabled' : 'disabled');
        }

        async function handleBioToggle(checkbox) {
            const username = localStorage.getItem('username');
            if (!window.webauthnJson) return;
            if (checkbox.checked) {
                try {
                    const challenge = btoa("1234567890123456").replace(/\+/g, '-').replace(/_/g, '/');
                    const userId = btoa(username || 'user').replace(/\+/g, '-').replace(/_/g, '/');
                    const credential = await window.webauthnJson.create({
                        publicKey: {
                            challenge, rp: { name: "Melder Suche", id: window.location.hostname },
                            user: { id: userId, name: username, displayName: username },
                            pubKeyCredParams: [{ type: "public-key", alg: -7 }],
                            authenticatorSelection: { userVerification: "required" }, timeout: 60000
                        }
                    });
                    const res = await fetch(`${API_BASE}/register-biometric`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${localStorage.getItem('token')}` },
                        body: JSON.stringify({ credential })
                    });
                    if (res.ok) localStorage.setItem('bio_registered_user', username);
                } catch (err) { checkbox.checked = false; }
            } else {
                if(!confirm("Biometrie deaktivieren?")) { checkbox.checked = true; return; }
                const res = await fetch(`${API_BASE}/register-biometric`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${localStorage.getItem('token')}` },
                    body: JSON.stringify({ action: 'delete' })
                });
                if(res.ok) localStorage.removeItem('bio_registered_user');
            }
        }

        // 2. Initialization & Core Logic
        async function initialize() {
            const role = localStorage.getItem('role');
            if (role === 'admin') document.getElementById('admin-nav').style.display = 'block';

            if (localStorage.getItem('darkMode') === 'enabled') {
                document.body.classList.add('dark-mode');
                document.getElementById('dark-toggle').checked = true;
            }

            const statusEl = document.getElementById('bio-status');
            if (window.webauthnJson) {
                statusEl.textContent = "Bereit"; statusEl.style.color = "var(--success)";
                if (localStorage.getItem('bio_registered_user')) document.getElementById('bio-toggle').checked = true;
            }

            try {
                const res = await fetch(`${API_BASE}/get-objects`);
                const objects = await res.json();
                const select = document.getElementById('object');
                select.innerHTML = ''; 
                objects.forEach(obj => {
                    const opt = document.createElement('option'); opt.value = obj.id; opt.textContent = obj.display;
                    select.appendChild(opt);
                });
                if (objects.length > 0) loadData();
            } catch (err) { document.getElementById('status').textContent = 'Ladefehler.'; }
        }

        async function loadData() {
            const objectKey = document.getElementById('object').value;
            if (!objectKey) return;
            document.getElementById('status').textContent = 'Daten werden geladen...';
            try {
                const response = await fetch(`${API_BASE}/get-data?id=${objectKey}`);
                data = await response.json();
                document.getElementById('status').textContent = `${data.length} Eintr√§ge geladen.`;
                clearSearch(true);
            } catch (e) { document.getElementById('status').textContent = 'Keine Daten gefunden.'; }
        }

        function clearSearch(keepStatus = false) {
            document.getElementById('search').value = '';
            document.getElementById('mobile-cards').classList.add('hidden');
            document.getElementById('table-wrapper').classList.add('hidden');
            document.getElementById('mobile-cards').innerHTML = '';
            document.getElementById('table-body').innerHTML = '';
            if(!keepStatus) document.getElementById('status').textContent = `${data.length} Eintr√§ge geladen.`;
        }

        function filterResults() {
            const query = document.getElementById('search').value.trim();
            const type = document.getElementById('searchType').value;
            const mobile = document.getElementById('mobile-cards');
            const table = document.getElementById('table-wrapper');
            const tableBody = document.getElementById('table-body');
            
            tableBody.innerHTML = ''; mobile.innerHTML = '';

            if (!query) {
                table.classList.add('hidden');
                mobile.classList.add('hidden');
                return;
            }

            const filtered = data.filter(item => {
                const val = type === 'gruppe' ? String(item.Gruppe || '') : String(item.Ring || '');
                return val === query;
            });

            if (filtered.length === 0) {
                table.classList.add('hidden');
                mobile.classList.remove('hidden');
                mobile.innerHTML = '<div class="status">Keine Treffer gefunden.</div>';
                document.getElementById('status').textContent = "";
            } else {
                table.classList.remove('hidden');
                mobile.classList.remove('hidden');
                document.getElementById('status').textContent = `${filtered.length} Treffer gefunden.`;
                filtered.forEach((item, index) => {
                    renderTableRow(item, index);
                    renderMobileCard(item, index);
                });
            }
        }

        function renderTableRow(item, index) {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><strong>${item.Gruppe || '-'}</strong></td>
                <td>${item.Installationsort || '-'}</td>
                <td>${item.Ring || '-'}</td>
                <td>${item.AnzMelder || '-'}</td>
                <td>
                    <button class="btn-details" onclick="toggleDetails('dt-${index}', this)">Details</button>
                    <div id="dt-${index}" class="details-pane">${formatTechnicalDetails(item)}</div>
                </td>
            `;
            document.getElementById('table-body').appendChild(tr);
        }

        function renderMobileCard(item, index) {
            const div = document.createElement('div');
            div.className = 'result-item';
            div.innerHTML = `
                <div class="card-row"><span class="card-label">Gruppe:</span> <strong>${item.Gruppe || '-'}</strong></div>
                <div class="card-row"><span class="card-label">Installationsort:</span> <span>${item.Installationsort || '-'}</span></div>
                <div class="card-row"><span class="card-label">Ring / AnzMelder:</span> <span>${item.Ring || '-'} / ${item.AnzMelder || '-'}</span></div>
                <button class="btn-details" style="width:100%; margin-top:10px" onclick="toggleDetails('dm-${index}', this)">Details anzeigen</button>
                <div id="dm-${index}" class="details-pane">${formatTechnicalDetails(item)}</div>
            `;
            document.getElementById('mobile-cards').appendChild(div);
        }

        function formatTechnicalDetails(item) {
            const technicalKeys = ["Gruppentyp", "Betriebsart", "Meldertechnik", "Alarmreaktion"];
            return technicalKeys.map(key => `<div><strong>${key}:</strong> ${item[key] || '-'}</div>`).join('');
        }

        function toggleDetails(id, btn) {
            const el = document.getElementById(id);
            const isVisible = el.style.display === 'block';
            el.style.display = isVisible ? 'none' : 'block';
            btn.textContent = isVisible ? (window.innerWidth < 768 ? "Details anzeigen" : "Details") : (window.innerWidth < 768 ? "Details schlie√üen" : "Schlie√üen");
        }

        function updateSearchUI() {
            const type = document.getElementById('searchType').value;
            document.getElementById('searchLabel').textContent = type === 'gruppe' ? 'Gruppe eingeben:' : 'Ring eingeben:';
            document.getElementById('search').placeholder = type === 'gruppe' ? 'z.B. 101' : 'z.B. 121';
            clearSearch();
        }

        // Search trigger on Enter
        document.getElementById('search').addEventListener('keypress', (e) => { if (e.key === 'Enter') filterResults(); });

        window.onload = initialize;
    </script>
</body>
</html>